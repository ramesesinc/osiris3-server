import com.rameses.annotations.*;
import com.rameses.util.*;
import java.rmi.server.*;
import com.rameses.common.*
import com.rameses.services.extended.*

class BankAccountPostService  {

	@PersistenceContext("main")
	def em;

	int lines_per_page = 25;

	private void moveNextPage( o ) {
		int lineno = o.currentlineno + 1;
		int pageno = o.currentpageno;
		if(lineno > lines_per_page ) {
			lineno = 1;
			pageno = pageno + 1;
		}
		o.currentlineno = lineno;
		o.currentpageno = pageno;
	}
	
	@ProxyMethod
	public def postDR( def o ) {
		if(!o.objid) throw new Exception("Objid is required");
		if(!o.amount)  throw new Exception("Amount is required");
		if(!o.refid) throw new Exception("Refid is required");
		if(!o.reftype) throw new Exception("Reftype is required");

		def cb = em.read( "bankaccount", o );
		if(cb.forwardbalance==null) cb.forwardbalance = 0;
		if(cb.beginbalance==null) cb.beginbalance = 0;
		if(cb.totaldr==null) cb.totaldr = 0;
		if(cb.totalcr==null) cb.totalce = 0;
		if(cb.endbalance==null) cb.endbalance = 0;

		def balance = cb.endbalance;
		cb.totaldr += o.amount;
		cb.endbalance = (cb.beginbalance + cb.forwardbalance + cb.totaldr) - cb.totalcr;
		
		def detail = [:];
		detail.objid = "BNKACCTE"+new UID();
		detail.parentid = cb.objid;
		detail.pageno = cb.currentpageno;
		detail.lineno = cb.currentlineno;
		
		detail.refid = o.refid;
		detail.refno = o.refno;
		detail.refdate = o.refdate;
		detail.reftype = o.reftype;
		detail.particulars = o.particulars;
		detail.dr = o.amount;	
		detail.cr = 0;
		detail.runbalance = cb.endbalance;
		em.create("bankaccount:detail", detail);
		
		moveNextPage( cb );
		em.update( "bankaccount", cb );
		return true;
	}

	@ProxyMethod
	public def postCR( def o ) {
		if(!o.objid) throw new Exception("Objid is required");
		if(!o.amount)  throw new Exception("Amount is required");
		if(!o.refid) throw new Exception("Refid is required");
		if(!o.reftype) throw new Exception("Reftype is required");

		def cb = em.read( "bankaccount", o );
		if(cb.forwardbalance==null) cb.forwardbalance = 0;
		if(cb.beginbalance==null) cb.beginbalance = 0;
		if(cb.totaldr==null) cb.totaldr = 0;
		if(cb.totalcr==null) cb.totalce = 0;
		if(cb.endbalance==null) cb.endbalance = 0;
		
		def balance = cb.endbalance;
		cb.totalcr += o.amount;
		cb.endbalance = (cb.beginbalance + cb.forwardbalance + cb.totaldr) - cb.totalcr;
		
		def detail = [:];
		detail.objid = "BNKACCTE"+new UID();
		detail.parentid = cb.objid;
		detail.pageno = cb.currentpageno;
		detail.lineno = cb.currentlineno;
		
		detail.refid = o.refid;
		detail.refno = o.refno;
		detail.refdate = o.refdate;
		detail.reftype = o.reftype;
		detail.particulars = o.particulars;
		detail.dr = 0;
		detail.cr = o.amount;	
		detail.runbalance = cb.endbalance;
		em.create("bankaccount:detail", detail);
		
		moveNextPage( cb );
		em.update( "bankaccount", cb );
		return true;
	}
	
}