import com.rameses.annotations.*;
import com.rameses.util.*;
import java.rmi.server.*;
import com.rameses.common.*
import com.rameses.services.extended.*

class RemittanceReportService  {

	@PersistenceContext("main")
	def em; 

	@Service("NumberService")
	def numSvc;

	@ProxyMethod 
	def getRCDReportData( remittanceid ) {
		def remittance = em.read('remittance:remittance', [objid: remittanceid] )
		if(! remittance ) throw new Exception("Could not open remittance with ojbid " + remittanceid )

		remittance.collectiontype = em.sqlContext.createNamedQuery('remittance:getRCDCollectionType').setParameter('remittanceid', remittanceid ).resultList
		remittance.collectionsummaries = em.sqlContext.createNamedQuery('remittance:getRCDCollectionSummaries').setParameter('remittanceid', remittanceid ).resultList
		remittance.remittedforms = em.sqlContext.createNamedQuery('remittance:getRCDRemittedForms').setParameter('remittanceid', remittanceid ).resultList
		remittance.otherpayments = em.sqlContext.createNamedQuery('remittance:getRCDOtherPayment').setParameter('remittanceid', remittanceid ).resultList

		//not yet implemented : waiting for sir elmo's db structure 
		remittance.nonserialremittances = []
		remittance.nonserialsummary = []

		remittance.amountinwords = numSvc.doubleToWords( remittance.amount).toUpperCase()

		return remittance 	

	}

	@ProxyMethod
	def generateReportByCollectionType( rem, collectiontype  ) {
		def data = rem.clone();
		def params = [
			remittanceid: data.objid, 
			collectiontypeid : collectiontype ? collectiontype.objid : '%'
		]

		data.receipts = em.sqlContext.createNamedQuery('remittance:getReceiptsByRemittanceCollectionType').setParameters(params ).resultList
		if( ! data.receipts ) throw new Exception("No record(s) found ");
		return data;
	}

	@ProxyMethod 
	def generateReportByFund( rem, fund ) {
		def data = rem.clone();
		def params = [ remittanceid: data.objid,  fundid : fund ? fund.objid : '%']
		data.receipts = em.sqlContext.createNamedQuery('remittance:getReceiptsByRemittanceFund').setParameters(params ).resultList
		if( ! data.receipts ) throw new Exception("No record(s) found ");
		data.acctsummaries = em.sqlContext.createNamedQuery('remittance:getRevenueItemSummaryByFund').setParameters(params ).resultList
		return data;
	}

	@ProxyMethod 
	def generateReportByRevenueItem( rem, fund ) {
		def data = rem.clone();
		def params = [ remittanceid: data.objid,  fundid : fund ? fund.objid : '%']
		data.acctsummaries = em.sqlContext.createNamedQuery('remittance:getRevenueItemSummaryByFund').setParameters(params ).resultList
		if( ! data.acctsummaries ) throw new Exception("No record(s) found ");
		return data;
	}

}