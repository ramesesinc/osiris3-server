import com.rameses.annotations.*;
import com.rameses.util.*;
import java.rmi.server.*;

class CashReceiptInterceptor {

	@ActiveDB("afserial_control")
	def em;

	@ActiveDB("stockitem")
	def stockitem;

	@After(pattern="CashReceiptService.init")
	public def loadNextSeries(def evt) { 
		def result = evt.result;

		//check if formno is cashticket or afserial
		def t = stockitem.findItemType( [objid:result.formno] ).type;
		if(t == "AFSERIAL") {
			def params = [afid:result.formno, userid: result.collector.objid, txnmode:result.txnmode]; 
			def m = em.findActiveControlForCashReceipt( params );
			if( !m) {
				throw new Warning("select-afcontrol");
			}
			result.stub = m.stub;
			result.receiptno = ((m.prefix)?m.prefix:'') + m.currentseries + ((m.suffix)?m.suffix:'');
			result.controlid = m.controlid;
			result.series = m.currentseries;
		}
		else {
			throw new Exception("Cashticket not supported!");
		}
	}

	@After(pattern="CashReceiptService.post")
	public def postAFControl(def evt) { 
		def result = evt.result;
		em.updateNextSeries([controlid:result.controlid]);
	}

	
	
}
